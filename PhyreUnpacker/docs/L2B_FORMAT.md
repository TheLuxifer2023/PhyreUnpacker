# L2B (Level 2 Binary) Format Documentation

## Обзор

L2B (Level 2 Binary) файлы — это бинарные архивы уровня, используемые в играх на базе PhyreEngine. Эти файлы используют формат **OFS3** (Object File System 3) для хранения структурированных данных уровня.

## Формат

L2B файлы являются OFS3 архивами. Подробное описание формата OFS3 см. в [OFS3_FORMAT.md](./OFS3_FORMAT.md).

## Содержимое L2B архивов

Извлечённые из L2B файлы могут содержать:

### 1. Структурированные данные уровня
- **Индексы и offsets** — таблицы индексов для вершин, объектов, секторов
- **Метаданные уровня** — информация о слоях, объектах, ссылках
- **Таблицы связей** — индексы для связывания объектов уровня

### 2. Геометрия
- **Vertex buffers** — буферы вершин (позиции, нормали, UV координаты)
- **Index buffers** — буферы индексов для треугольников
- **Структурированные данные** — геометрические данные без текстуры

### 3. Другие ресурсы
- **Метаданные** — таблицы и структуры данных
- **Ссылки на ресурсы** — указатели на другие файлы

## Анализ извлечённых файлов

### Характеристики данных

Извлечённые файлы из L2B архивов обычно:
- **Не являются текстурами** — несмотря на размер, подходящий для текстур, данные структурированы иначе
- **Содержат offsets и индексы** — первые байты часто содержат большие значения (offsets или индексы)
- **Могут быть сжаты** — некоторые данные могут быть в сжатом виде

### Пример структуры данных

```
Offset 0x00: [uint32] Offset 1 (0x001B848E = 1803406)
Offset 0x04: [uint32] Offset 2 (0x001B82F0 = 1802992)
Offset 0x08: [uint32] Count/Flags (0x00000008 = 8)
Offset 0x0C: [uint32] Offset 3 (0x001B84B2 = 1803442)
...
```

Эти значения указывают на то, что данные являются структурированными таблицами с offsets или индексами.

## Использование в PhyreEngine

### Загрузка уровня

PhyreEngine загружает уровни через:
1. **XML файлы (.plv)** — основное описание уровня
2. **Бинарные секторы (l2b)** — скомпилированные данные уровня
3. **Asset файлы (.phyre)** — ресурсы уровня (текстуры, модели)

### Связь с Level Loader

PhyreEngine использует `PLevelLoader` для загрузки XML описаний уровня, но бинарные данные уровня (l2b) могут загружаться через:
- **FIOS (File I/O System)** — система файлового ввода-вывода на PlayStation платформах
- **OFS3 распаковка** — распаковка архивов перед загрузкой
- **Прямая загрузка** — загрузка распакованных данных

## Анализ файлов

### Использование PhyreUnpacker

```bash
# Извлечение L2B архива
PhyreUnpacker.exe --extract-ofs3 level.l2b -o ./extracted --verbose

# Анализ извлечённых файлов
PhyreUnpacker.exe --analyze extracted/file_0.phyre
PhyreUnpacker.exe --analyze extracted/file_1.phyre
```

### Что анализировать

1. **Поиск PHYR маркеров** — проверка, содержит ли файл Phyre кластеры
2. **Анализ структуры** — определение типов данных (индексы, offsets, геометрия)
3. **Энтропия данных** — определение, сжаты ли данные
4. **Паттерны байтов** — поиск повторяющихся паттернов (геометрия, индексы)

## Рекомендации по работе с L2B

### Если файлы не являются текстурами

1. **Проверьте структуру данных:**
   - Первые байты часто содержат offsets или индексы
   - Данные могут быть структурированными таблицами
   - Возможно наличие заголовков с метаданными

2. **Попробуйте загрузить как Phyre кластер:**
   - Проверьте наличие маркера "PHYR" в файле
   - Используйте `PCluster::LoadAssetFile()` для загрузки

3. **Анализируйте как геометрию:**
   - Данные могут быть vertex/index buffers
   - Проверьте размеры и структуру вершин

4. **Ищите метаданные:**
   - Таблицы индексов
   - Структуры данных уровня
   - Ссылки на другие ресурсы

## Известные ограничения

1. **Структура данных неизвестна** — точная структура содержимого L2B файлов требует дополнительного анализа
2. **Не все файлы текстуры** — несмотря на размер, подходящий для текстур, большинство файлов являются структурированными данными
3. **Требуется дополнительный анализ** — для полного понимания формата нужны дополнительные исследования

## Связанные форматы

- **OFS3** — формат архива L2B файлов
- **.plv** — XML описание уровня
- **.phyre** — Phyre кластеры (ресурсы)
- **PHYR** — бинарный формат PhyreEngine

## Источники

- Анализ реальных L2B файлов из игр на PhyreEngine
- Документация PhyreEngine SDK
- Анализ кода `PLevelLoader` и `PhyreLevelLoader.cpp`

---

*Документация создана на основе анализа файлов и кода PhyreEngine SDK.*

