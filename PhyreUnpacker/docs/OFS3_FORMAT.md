# OFS3 (Object File System 3) Format Documentation

## Обзор

OFS3 (Object File System 3) — это формат архива, используемый в играх на базе PhyreEngine, особенно для файлов `.l2b` (Level 2 Binary). Формат позволяет хранить несколько файлов в одном архиве с таблицей содержимого.

## Структура файла

### Заголовок (Header)

OFS3 файл начинается с заголовка размером минимум 16 байт:

```
Offset | Size | Type   | Description
-------|------|--------|-------------
0x00   | 4    | char[] | Magic number: "OFS3" (0x4F 0x46 0x53 0x33)
0x04   | 4    | uint32 | Version/Flags (little-endian)
0x08   | 4    | uint32 | Flags (little-endian)
0x0C   | 4    | uint32 | Data offset - смещение к началу данных (little-endian)
```

**Пример заголовка:**
```
4F 46 53 33 10 00 00 00 02 00 40 00 30 83 1B 00
```

Расшифровка:
- `4F 46 53 33` = "OFS3"
- `10 00 00 00` = Version/Flags = 0x00000010 (16)
- `02 00 40 00` = Flags = 0x00400002
- `30 83 1B 00` = Data offset = 0x001B8330 (1803056 байт)

### Таблица файлов (File Table)

Сразу после заголовка (начиная с offset 0x10) находится таблица файлов. Каждая запись имеет размер 16 байт:

```
Offset (в записи) | Size | Type   | Description
------------------|------|--------|-------------
0x00              | 4    | uint32 | Name offset - смещение к имени файла (little-endian)
0x04              | 4    | uint32 | File offset - смещение к данным файла (little-endian)
0x08              | 4    | uint32 | File size (возможно, сжатый размер или флаги) (little-endian)
0x0C              | 4    | uint32 | Next offset - смещение следующего файла или data offset (little-endian)
```

**Структура таблицы:**
- Таблица находится между offset 0x10 и data offset (0x001B8330 в примере)
- Количество записей определяется из заголовка (поле flags, возможно)

**Пример записи:**
```
09 00 00 00 70 00 00 00 98 03 00 00 30 83 1B 00
```

Расшифровка:
- `09 00 00 00` = Name offset = 0x00000009
- `70 00 00 00` = File offset = 0x00000070 (112 байт)
- `98 03 00 00` = File size = 0x00000398 (920 байт)
- `30 83 1B 00` = Next offset = 0x001B8330 (data offset, последний файл)

### Область данных (Data Section)

Область данных начинается с offset, указанного в заголовке (data offset). Здесь хранятся:
1. Данные файлов (начиная с их file offset из таблицы)
2. Возможно, имена файлов (если name offset указывает на эту область)

## Алгоритм извлечения файлов

1. **Чтение заголовка:**
   - Проверить magic number "OFS3"
   - Прочитать data offset

2. **Чтение таблицы файлов:**
   - Начать с offset 0x10
   - Читать записи по 16 байт
   - Для каждого файла:
     - Прочитать name offset, file offset, file size, next offset
     - Определить реальный размер файла:
       - Если это не последний файл: размер = (offset следующего файла) - (file offset)
       - Если это последний файл: размер = (data offset) - (file offset)

3. **Извлечение данных:**
   - Перейти к file offset каждого файла
   - Прочитать данные размером, рассчитанным на шаге 2
   - Сохранить в выходной файл

## Особенности формата

### Определение размера файлов

Поле "File size" в таблице может не соответствовать реальному размеру. Реальный размер рассчитывается по offset следующего файла:

```cpp
if (не последний файл) {
    realSize = nextFile.offset - currentFile.offset;
} else {
    realSize = dataOffset - currentFile.offset;
}
```

### Имена файлов

Поле "Name offset" может указывать на:
- Строку в области данных
- Метаданные в таблице
- Относительный offset (требует дополнительного исследования)

Если имя файла не удаётся прочитать, используется имя по умолчанию: `file_N.phyre` или `file_N.bin`.

### Типы данных

Извлечённые файлы могут содержать:
- **Phyre кластеры** (файлы с маркером "PHYR") — стандартные файлы PhyreEngine
- **Сырые данные** — текстуры, геометрия, аудио без обёртки PHYR
- **Метаданные** — таблицы индексов, ссылок, структуры данных

## Примеры использования

### Извлечение всех файлов

```bash
PhyreUnpacker.exe --extract-ofs3 archive.l2b -o ./output --verbose
```

### Анализ структуры

```bash
PhyreUnpacker.exe --analyze archive.l2b
```

### Анализ извлечённых файлов

```bash
PhyreUnpacker.exe --analyze extracted/file_0.phyre
```

## Ограничения и неизвестные детали

1. **Количество файлов:** Точное определение количества файлов требует дополнительного исследования (поле flags в заголовке)
2. **Сжатие:** Возможна поддержка сжатия файлов (не подтверждено)
3. **Имена файлов:** Точная структура хранения имён файлов требует дополнительного анализа
4. **Платформенные различия:** Могут быть различия между версиями для разных платформ

## Известные поля Flags

- `0x00400002` — наблюдается в файлах PS4/PS5
- Требуется дополнительное исследование для полной расшифровки

## Связанные форматы

- **PHYR** — формат PhyreEngine кластеров (извлекаемые файлы могут быть в этом формате)
- **.l2b** — расширение файлов OFS3 архивов (Level 2 Binary)
- **OFS2** — предыдущая версия формата (если существует)

## Источники

Анализ формата основан на обратном проектировании реальных файлов из игр на базе PhyreEngine.

---

*Документация создана на основе анализа файлов, извлечённых с помощью PhyreUnpacker.*

